name: Debug Server State

on:
    workflow_dispatch: # Allows manual trigger

jobs:
    inspect:
        runs-on: ubuntu-latest
        steps:
            - name: Inspect Server via SSH
              uses: appleboy/ssh-action@v1.0.0
              with:
                  host: ${{ secrets.SERVER_HOST }}
                  username: ${{ secrets.SERVER_USER }}
                  key: ${{ secrets.SERVER_SSH_KEY }}
                  script: |
                      echo "=== FILESYSTEM INSPECTION ==="
                      ls -la /var/www/whiskeylabs-website
                      echo ""
                      echo "=== WEB DIR INSPECTION ==="
                      ls -la /var/www/whiskeylabs-website/web
                      echo ""
                      echo "=== GIT HISTORY ON SERVER ==="
                      cd /var/www/whiskeylabs-website && git log -n 5
                      echo ""
                      echo "=== SYSTEM PATHS ==="
                      echo $PATH
                      echo ""
                      echo "=== SEARCHING FOR PM2 ==="
                      which pm2 || find / -name pm2 -type f 2>/dev/null | grep bin | head -n 5 || echo "pm2 not found"
                      echo ""
                      echo "=== NVM CHECK ==="
                      export NVM_DIR="$HOME/.nvm"
                      [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
                      which node
                      which npm
                      which pm2 || echo "pm2 still not found after NVM"
                      echo ""
                      echo "=== PM2 STATUS ==="
                      pm2 list
                      echo ""
                      echo "=== WHISKEYLABS PROCESS DETAILS ==="
                      pm2 show whiskeylabs || echo "Process 'whiskeylabs' not found in PM2"
                      echo ""
                      echo "=== NGINX CONFIG ==="
                      cat /etc/nginx/sites-enabled/whiskeylabs || echo "Nginx config not found"
                      echo ""
                      echo "=== LISTENING PORTS ==="
                      netstat -tulpn | grep LISTEN || ss -tulpn | grep LISTEN
                      echo ""
                      echo "=== CURRENT DATE ON SERVER ==="
                      date
